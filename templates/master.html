<!DOCTYPE html>
<html lang="en">

{% load static %}

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Matrix - Dashboard</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"/>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- Custom fonts for this template-->
    <link href="{% static "vendor/fontawesome-free/css/all.min.css" %}" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="{% static "css/sb-admin-2.min.css" %}" rel="stylesheet">
    
    <link rel="icon" type="image/png" sizes="192x192" href="{% static 'icons/android-icon-192x192.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'icons/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="96x96" href="{% static 'icons/favicon-96x96.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'icons/favicon-16x16.png' %}">
    <link rel="manifest" href="{% static 'icons/manifest.json' %}">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="{% static 'icons/ms-icon-144x144.png' %}">
    <meta name="theme-color" content="#ffffff">

    {% block style %}


    
    {% endblock %}

    <style>
    
 
        .spinner-border {
            display: none; /* Initially hidden */
            width: 10px; /* Adjust size as needed */
            height: 10px; /* Adjust size as needed */
            vertical-align: middle; /* Aligns the spinner with the button text */
            margin-left: 10px; /* Space between text and spinner */
        }

        .glassy-content-wrapper {
            
            
           
            border-radius: 15px; // Rounded corners
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); // Subtle shadow
            backdrop-filter: blur(10px); // Apply blur effect for glassmorphism
            z-index: 1; // Ensure it's below the modal but above other content
            position: relative; // Ensure it doesn't affect the modal
            
            
            z-index: 1040; // Ensure it's below the modal but above other content
            backdrop-filter: none; // Disable backdrop-filter for the custom backdrop
           
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            
        }
            /* Topbar Modern Custom Styles */
        #top-bar, .topbar-custom {
            background: linear-gradient(135deg, rgba(25, 29, 230, 0.99), rgba(18, 15, 190, 0.92));
            border-radius: 5px;
            position: sticky;
            top: 0;
            z-index: 1030;
            height: 50px;
            color: #fff;
            font-weight: 500;
            font-size: 1rem;
            display: flex;
            align-items: center;
            padding: 0 16px;
            box-shadow: 0 2px 8px rgba(25, 29, 230, 0.07);
            margin: 0 8px 8px 8px;
            min-height: 48px;
        }
         /* Message notification badge for sidebar and topbar */
        .msg-bell-animate {
            animation: bell-shake 1.2s cubic-bezier(.36,.07,.19,.97) both infinite;
        }
        @keyframes bell-shake {
            0% { transform: rotate(0); }
            10% { transform: rotate(-15deg); }
            20% { transform: rotate(10deg); }
            30% { transform: rotate(-10deg); }
            40% { transform: rotate(6deg); }
            50% { transform: rotate(-3deg); }
            60%, 100% { transform: rotate(0); }
        }
        .notify-badge {
            background: #fd7e14;
            color: #fff;
            border-radius: 50%;
            font-size: 0.8em;
            font-weight: 700;
            padding: 2px 6px;
            position: absolute;
            top: 0px;
            right: 2px;
            z-index: 11;
            box-shadow: 0 1px 2px #d66;
        }
        .sidebar .nav-link .msg-sidebar-icon {
            position: relative;
        }

       
        .orange-border {
            border: 1.5px solid #fd7e14 !important;
            box-shadow: none;
        }
        .img-profile.topbar-profile-img {
            height: 38px;
            width: 38px;
            object-fit: cover;
            margin-left: 8px;
            border: 2px solid #fd7e14;
            background: #fff;
        }
        .username-custom {
            color: #fff !important;
            font-size: 1rem;
            letter-spacing: 0.01em;
            font-weight: 600;
            margin-right: 5px;
        }
        .navbar-nav .dropdown-menu {
            font-size: 0.97rem;
        }
        @media (max-width: 991.98px) {
            #top-bar, .topbar-custom {
                padding: 0 6px;
                font-size: 0.92rem;
            }
            .topbar-search-custom {
                min-width: 120px;
                max-width: 180px;
                width: 150px;
                margin: 0 10px;
            }
            .img-profile.topbar-profile-img {
                height: 32px;
                width: 32px;
            }
            .username-custom {
                font-size: 0.95rem;
            }
        }
        @media (max-width: 575.98px) {
            #top-bar, .topbar-custom {
                font-size: 0.90rem;
                min-height: 44px;
                height: 44px;
                margin: 0 1px 6px 1px;
            }
            .topbar-search-custom {
                min-width: 80px;
                max-width: 100px;
                width: 105px;
                margin: 0 6px;
            }
            .img-profile.topbar-profile-img {
                height: 28px;
                width: 28px;
                margin-left: 5px;
            }
            .username-custom {
                font-size: 0.90rem;
            }
        }
        /* Orange border for the search input */
        .orange-border {
            border: 2px solid #FF8C00; /* Dark orange color */
        }

        /* Black text for the search input */
        .orange-border::placeholder {
            color: black; /* Placeholder text color */
        }

        .orange-border {
            color: black; /* Input text color */
        }

        /* Larger black text for the username */
        .large-username {
            font-size: 1.2rem; /* Adjust the size as needed */
            color: black; /* Set text color to black */
        }


    </style>
    <style>
        .sidebar {
            background: linear-gradient(135deg,rgba(25, 29, 230, 0.99),rgba(18, 15, 190, 0.86)); /* Modern gradient */
            border-radius:5px;
            margin-left:5px;
          
        }
        

        .sidebar .nav-link {
            color:  #FF8C00; /* Light text color */
            transition: background-color 0.3s, color 0.3s; /* Smooth transition */
        }

        .sidebar .nav-link:hover {
            background-color: rgb(26, 35, 76); /* Light background on hover */
            color:rgb(0, 0, 0); /* White text on hover */
            
        }

        .sidebar .nav-item.active .nav-link {
            background-color:  #FF8C00; /* Active item background */
            color: #ffffff; /* White text for active item */
            border-radius:10px
        }

        .sidebar-heading {
            color: #ffffff; /* White color for headings */
            font-weight: bold; /* Bold headings */
            padding: 10px 15px; /* Padding for headings */
        }

        .collapse-inner {
            background-color: rgba(255, 255, 255, 0.1); /* Slightly transparent background for collapse items */
        }

        .collapse-item {
            color: rgba(255, 255, 255, 0.8); /* Light text color for collapse items */
        }

        .collapse-item:hover {
            color: #ffffff; /* White text on hover for collapse items */
        }
        .text-warning-300{
            color:rgb(226, 114, 33) !important;
        }
        .btn-warning{
            background-color:rgb(226, 114, 33) !important;
        }
        .input-group-append{
            color:rgb(226, 114, 33) !important;
        }
        
       
    </style>
    <style>
        /* ... (your custom styles from earlier) ... */
        .msg-bell-animate {
            animation: bell-shake 1.2s cubic-bezier(.36,.07,.19,.97) both infinite;
        }
        @keyframes bell-shake {
            0% { transform: rotate(0); }
            10% { transform: rotate(-15deg); }
            20% { transform: rotate(10deg); }
            30% { transform: rotate(-10deg); }
            40% { transform: rotate(6deg); }
            50% { transform: rotate(-3deg); }
            60%, 100% { transform: rotate(0); }
        }
        .notify-badge {
            background: #fd7e14;
            color: #fff;
            border-radius: 50%;
            font-size: 0.8em;
            font-weight: 700;
            padding: 2px 6px;
            position: absolute;
            top: 0px;
            right: 2px;
            z-index: 11;
            box-shadow: 0 1px 2px #d66;
        }
        /* ... (rest of your sidebar, topbar, and general styles) ... */
    </style>
   
</head>




<body class="bg-gradient-light sidebar-toggled  ">
  

    <!-- Page Wrapper -->
    <div id="wrapper">

     
        <!-- Sidebar -->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark toggled accordion" id="accordionSidebar">

            

            <!-- Divider -->
            <hr class="sidebar-divider my-0">

            <!-- Nav Item - Dashboard -->
            <li class="nav-item {% if request.get_full_path == "/" %}active{% endif %}">
                <a class="nav-link" href="{% url 'index' %}">
                    <i class="fas fa-fw  fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                Participants
            </div>

            <!-- Participants Section -->
            <li class="nav-item {% if request.get_full_path == "/participant/" or request.get_full_path == "/enroll/" or request.get_full_path == "/progress/" %}active{% endif %}">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseParticipants" aria-expanded="true" aria-controls="collapseParticipants">
                    <i class="fas fa-fw   fa-users"></i>
                    <span>Candidates</span>
                </a>
                <div id="collapseParticipants" class="collapse" aria-labelledby="headingParticipants" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Candidates:</h6>
                        <a class="collapse-item" href="{% url 'participant.index' %}">Inquiries</a>
                        <a class="collapse-item" href="{% url 'enroll.index' %}">Enrolls</a>
                        <a class="collapse-item" href="{% url 'extension_list' %}">Extension</a>
                        <a class="collapse-item" href="{% url 'enroll.incoming_participants' %}">Incoming</a>
                        <a class="collapse-item" href="{% url 'enroll.completed_participants' %}">Completions</a>
                    </div>
                </div>
            </li>

            <!-- Camp & Fees Section -->
            {% if user.profile.role in "president vice_president operations_manager assistant_operations_manager" %}
            <li class="nav-item {% if request.get_full_path == "/program/" %}active{% endif %}">
                <a class="nav-link" href="{% url 'program.index' %}">
                    <i class="fas   fas fa-hiking "></i>
                    <span>Camp & Fees</span>
                </a>
            </li>
            {% endif %}

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                Payments
            </div>

            <!-- Payments Section -->
            <li class="nav-item {% if request.get_full_path == "/payment/" %}active{% endif %}">
                <a class="nav-link" href="{% url 'payment.index' %}">
                    <i class="fas   fa-fw fa-dollar-sign"></i>
                    <span>Payments</span>
                </a>
            </li>

            <!-- Expenses Section -->
            {% if user.profile.role in "operations_manager assistant_operations_manager vice_president president admin" %}
            <li class="nav-item {% if request.get_full_path == "/expense/" %}active{% endif %}">
                <a class="nav-link" href="{% url 'expense.index' %}">
                    <i class="fa  fa-cart-plus" aria-hidden="true"></i>
                    <span>Expenses</span>
                </a>
            </li>
            {% endif %}

            <!-- Reports Section -->
            {% if user.profile.role in "operations_manager assistant_operations_manager admin vice_president president admin" %}
            <li class="nav-item {% if request.get_full_path == "/payment/report/" %}active{% endif %}">
                <a class="nav-link" href="{% url 'payment.report' %}">
                    <i class="fas fa-fw  fa-print"></i>
                    <span>Reports</span>
                </a>
            </li>
            {% endif %}

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                Staff Management
            </div>

            <!-- Staff Management Section -->
            {% if user.profile.role in "president  vice_president operations_manager assistant_operations_manager " %}
            <li class="nav-item {% if request.get_full_path == "/staff/" or request.get_full_path == "/enroll/" or request.get_full_path == "/progress/" %}active{% endif %}">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseStaff" aria-expanded="true" aria-controls="collapseStaff">
                    <i class="fas fa-fw   fa-users"></i>
                    <span>Matrix Staff</span>
                </a>
                <div id="collapseStaff" class="collapse" aria-labelledby="headingStaff" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Staff:</h6>
                        <a class="collapse-item" href="{% url 'staff.index' %}">Members</a>
                        
                    </div>
                </div>
            </li>
            {% endif %}
                        
                        <!-- Payroll Section -->
            <li class="nav-item {% if request.path|slice:":8" == '/payslip/' %}active{% endif %}">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePayroll" aria-expanded="true" aria-controls="collapsePayroll">
                    <i class="fas fa-fw fa-money-check-alt"></i>
                    <span>Payroll</span>
                </a>
                <div id="collapsePayroll" class="collapse {% if request.path|slice:":8" == '/payslip/' %}show{% endif %}" aria-labelledby="headingPayroll" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Payroll:</h6>
                        <a class="collapse-item" href="{% url 'payslip.index' %}">Payslips</a>
                        <a class="collapse-item" href="{% url 'payslip.create' %}">Generate Payslip</a>
                    </div>
                </div>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Messaging Section -->
            <div class="sidebar-heading">
                Messaging
            </div>
            <li class="nav-item {% if request.get_full_path|slice:":9" == "/messages" %}active{% endif %}">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseMessages" aria-expanded="true" aria-controls="collapseMessages">
                    <span class="msg-sidebar-icon" style="position:relative;">
                        <i class="fas fa-envelope{% if unread_message_count > 0 %} msg-bell-animate text-orange{% endif %}"></i>
                        {% if unread_message_count > 0 %}
                            <span class="notify-badge">{{ unread_message_count }}</span>
                        {% endif %}
                    </span>
                    <span>Messages</span>
                </a>
                <div id="collapseMessages" class="collapse {% if request.get_full_path|slice:":9" == "/messages" %}show{% endif %}" aria-labelledby="headingMessages" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="{% url 'messages:inbox' %}">
                            <i class="fas fa-inbox fa-fw text-blue"></i> Inbox
                            {% if unread_message_count > 0 %}
                                <span class="badge badge-danger ml-2">{{ unread_message_count }}</span>
                            {% endif %}
                        </a>
                        <a class="collapse-item" href="{% url 'messages:sent_messages' %}">
                            <i class="fas fa-paper-plane fa-fw text-orange"></i> Sent
                        </a>
                        <a class="collapse-item" href="{% url 'messages:send_message' %}">
                            <i class="fas fa-feather-alt fa-fw text-success"></i> Compose
                        </a>
                    </div>
                </div>
            </li>
            
            
            

            <!-- Divider -->
            <hr class="sidebar-divider">

            {% if user.is_staff %}
            <!-- Heading -->
            <div class="sidebar-heading">
                Users
            </div>

            <!-- Nav Item - User Management -->
            <li class="nav-item">
                <a class="nav-link" href="/admin/auth/user/">
                    <i class="fas fa-fw   fa-user"></i>
                    <span>Users</span>
                </a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider d-none d-md-block">
            {% endif %}

            <!-- Sidebar Toggler -->
            <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0" id="sidebarToggle"></button>
            </div>

            <!-- Sidebar Message -->
            {% block sidebar %} {% endblock %}

        </ul>

<!-- End of Sidebar -->

           
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column  ">

            

                <!-- Main Content -->
                <div id="content" style="max-height: 100vh; overflow-y ">
                    <div class="glassy-content-wrapper">

                    <!-- Topbar -->
        <nav class="navbar navbar-expand navbar-light topbar-custom mb-2 shadow" id="top-bar">
            <!-- Sidebar Toggle (Topbar) -->
            <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-2">
                <i class="fa fa-bars"></i>
            </button>
        
            
            
            <!-- Topbar Navbar -->
            <ul class="navbar-nav ml-auto align-items-center">
                
                 <!-- Messages Dropdown -->
                <li class="nav-item dropdown no-arrow mx-1">
                    <a class="nav-link dropdown-toggle" href="#" id="messagesDropdown" role="button"
                       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-envelope{% if unread_message_count > 0 %} msg-bell-animate text-orange{% endif %}"></i>
                        {% if unread_message_count > 0 %}
                            <span class="badge badge-danger badge-counter">{{ unread_message_count }}</span>
                        {% endif %}
                    </a>
                    <!-- Messages Dropdown -->
                            <li class="nav-item dropdown no-arrow mx-1" id="messages-dropdown-nav">
                                <a class="nav-link dropdown-toggle" href="#" id="messagesDropdown" role="button"
                                   data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="msg-sidebar-icon" style="position:relative;">
                                        <i class="fas fa-envelope" id="msg-bell-icon"></i>
                                        <span class="badge badge-danger badge-counter" id="msg-badge-top" style="display:none;">0</span>
                                    </span>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in p-0" aria-labelledby="messagesDropdown" style="min-width: 360px;">
                                    <h6 class="dropdown-header text-center bg-primary text-white py-2">
                                        Messages
                                        <a href="{% url 'messages:inbox' %}" class="float-right text-white-50" title="Go to Inbox"><i class="fas fa-arrow-right"></i></a>
                                    </h6>
                                    <div class="p-2" id="recent-messages-dropdown">
                                        <span class="dropdown-item text-muted small text-center">Loading...</span>
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item text-center small text-gray-500" href="{% url 'messages:inbox' %}">
                                        View All Messages
                                    </a>
                                </div>
                            </li>
                </li>
        
                <!-- Other nav items -->
                <li class="nav-item dropdown no-arrow">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button"
                       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="mr-2 d-none d-lg-inline text-white font-weight-bold username-custom">{{ user.get_username }}</span>
                        {% if user.profile.profile_image %}
                        <img src="{{ user.profile.profile_image.url }}" alt="Profile Image"
                             class="img-profile rounded-circle topbar-profile-img" />
                        {% else %}
                        <img src="{% static 'images/default.jpg' %}" alt="Default Profile"
                             class="img-profile rounded-circle topbar-profile-img" />
                        {% endif %}
                    </a>
                    <!-- Dropdown - User Information -->
                    <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in" aria-labelledby="userDropdown">
                        <a class="dropdown-item" href="{% url 'account.profile' %}">
                            <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                            Profile
                        </a>
                        {% if user.profile.role in "president vice_president operations_manager assistant_operations_manager" %}
                        <a class="dropdown-item" href="{% url 'activity' %}">
                            <i class="fas fa-list fa-sm fa-fw mr-2 text-gray-400"></i>
                            Activity Log
                        </a>
                        {% endif %}
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="javascript:void(0)" data-toggle="modal" data-target="#logoutModal">
                            <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                            Logout
                        </a>
                    </div>
                </li>
            </ul>
        </nav>
        <!-- End of Topbar -->
        
                            <!-- Begin Page Content -->
                            <div class="container-fluid"  id="main-content">
        
                                <!-- Page Heading -->
                                {% block heading %} {% endblock %}
                            
                                {% block content %} {% endblock %}
                            
                            </div>
                            <!-- /.container-fluid -->
                            </div>
        
                        </div>
                        <!-- End of Main Content -->
                   </div>
        
                    
        
                </div>
                <!-- End of Content Wrapper -->
        
            </div>
            <!-- End of Page Wrapper -->
        
            <!-- Scroll to Top Button-->
            <a class="scroll-to-top rounded" href="#page-top">
                <i class="fas fa-angle-up"></i>
            </a>
        
            <!-- Logout Modal-->
        <!-- Logout Modal-->
        <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                    </div>
                    <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                        <form action="{% url 'account.logout' %}" class="d-inline-block" method="post" id="logoutForm">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary" id="logoutButton">
                                Logout
                                <div class="spinner-border text-warning" role="status" id="logoutSpinner" style="display: none;">
                                    
                                </div>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

<style>
    .spinner-border {
        display: none; /* Initially hidden */
        width: 1em; /* Adjust size as needed */
        height: 1em; /* Adjust size as needed */
        vertical-align: middle; /* Aligns the spinner with the button text */
        margin-left: 0.5em; /* Space between text and spinner */
        color:orange;
    }
</style>

    <div id="toast-container" aria-live="polite" aria-atomic="true" style="position: fixed; top: 26px; right: 20px; min-width: 345px; z-index: 9999;"></div>
     <script>
    // Show toast using Toastify.js, avoid repeats
    window.lastToastMsg = '';
    function showToast(msg) {
        if (window.lastToastMsg === msg) return;
        window.lastToastMsg = msg;
        Toastify({
            text: msg,
            duration: 3000,
            close: true,
            gravity: "top",
            position: "right",
            backgroundColor: "#fd7e14",
            stopOnFocus: true,
            onClick: function(){ window.lastToastMsg = ''; }
        }).showToast();
        setTimeout(() => { window.lastToastMsg = ''; }, 3500);
    }

    // Update the recent messages dropdown in topbar
    function updateMessagesDropdown(messages) {
        let dropdown = document.getElementById("recent-messages-dropdown");
        if (!dropdown) return;
        if (messages.length === 0) {
            dropdown.innerHTML = '<span class="dropdown-item text-muted small text-center">No new messages!</span>';
            return;
        }
        dropdown.innerHTML = "";
        messages.slice(0, 5).forEach(msg => {
            let sender = msg.sender_full_name || msg.sender_username;
            let imgSrc = msg.sender_profile_image || "{% static 'images/default.jpg' %}";
            let unreadSpan = (!msg.read) ? '<span class="notify-badge" style="top: -2px; right: -2px;">!</span>' : '';
            dropdown.innerHTML += `
                <a class="dropdown-item d-flex align-items-center" href="/messages/detail/${msg.id}/">
                    <div class="dropdown-list-image mr-3">
                        <img class="rounded-circle" src="${imgSrc}" alt="Sender" style="width: 42px; height: 42px; object-fit: cover;">
                        ${unreadSpan}
                    </div>
                    <div class="font-weight-bold flex-grow-1">
                        <div class="text-truncate">${msg.body}</div>
                        <div class="small text-gray-500">${sender} �� ${msg.timesince} ago</div>
                    </div>
                </a>
            `;
        });
    }

    // Polling for new messages and updating badge/dropdown/toast
    let prevUnread = null;
    let prevMsgIds = [];
    function pollInboxTopbar() {
        fetch("{% url 'messages:poll_new_messages' %}?dropdown=1")
            .then(resp => resp.json())
            .then(data => {
                let unread = data.unread || 0;
                let badge = document.getElementById("msg-badge-top");
                let bell = document.getElementById("msg-bell-icon");

                // Show/hide badge and animate bell if unread
                if (badge) {
                    if (unread > 0) {
                        badge.textContent = unread;
                        badge.style.display = "inline-block";
                        bell.classList.add("msg-bell-animate", "text-orange");
                    } else {
                        badge.style.display = "none";
                        bell.classList.remove("msg-bell-animate", "text-orange");
                    }
                }

                // Show toast if unread increased
                if (prevUnread !== null && unread > prevUnread) {
                    showToast("You have " + (unread - prevUnread) + " new message" + ((unread-prevUnread)>1?"s":"") + "!");
                }
                prevUnread = unread;

                // Update dropdown with recent messages
                if (data.recent_messages) {
                    // Only show toast for new unseen message IDs
                    let newIds = data.recent_messages.map(m => m.id);
                    let unseen = newIds.filter(id => !prevMsgIds.includes(id));
                    if (unseen.length && prevMsgIds.length) {
                        showToast("You have a new message!");
                    }
                    prevMsgIds = newIds;
                    updateMessagesDropdown(data.recent_messages);
                }
            });
    }
    setInterval(pollInboxTopbar, 5000);
    document.addEventListener('DOMContentLoaded', pollInboxTopbar);
    </script>

    <script>
document.addEventListener("DOMContentLoaded", function() {
    // Only connect if user is authenticated (inject a JS variable via Django if needed)
    let ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
    let ws_path = ws_scheme + "://" + window.location.host + "/ws/notifications/";
    let socket = new WebSocket(ws_path);

    socket.onmessage = function(e) {
        let data = JSON.parse(e.data);
        Toastify({
            text: data.title + ": " + data.body,
            duration: 10000,
            close: true,
            gravity: "top",
            position: "right",
            backgroundColor: "#fd7e14",
            stopOnFocus: true,
            onClick: function(){
                window.location.href = "/messages/message/" + data.message_id + "/";
            }
        }).showToast();
    };

    socket.onclose = function(e) {
        // Optionally handle reconnects
    }
});
</script>

    <script>
    function checkNewMessages() {
        fetch("{% url 'messages:new_message_count' %}")
            .then(resp => resp.json())
            .then(data => {
                if (data.unread > 0) {
                    showToast("You have " + data.unread + " new message" + (data.unread === 1 ? "" : "s") + "!");
                }
            });
    }
    setInterval(checkNewMessages, 5000);

    function showToast(msg) {
        // Your toast implementation, or call your existing toast function
    }
  </script>



    <!-- Bootstrap core JavaScript-->
    <script src="{% static "vendor/jquery/jquery.min.js" %}"></script>
    <script src="{% static "vendor/bootstrap/js/bootstrap.bundle.min.js" %}"></script>

    <!-- Core plugin JavaScript-->
    <script src="{% static "vendor/jquery-easing/jquery.easing.min.js" %}"></script>

    <!-- Custom scripts for all pages-->
    <script src="{% static "js/sb-admin-2.min.js" %}"></script>
    


    {% block script %}
   


    
    
    {% endblock %}

   

</body>
</html>

           